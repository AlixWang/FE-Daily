# æ·±å…¥react-fiber-(reactæ–°è°ƒåº¦ç®—æ³•çš„æ·±å…¥ç†è§£) #

![head-picture](http://ww1.sinaimg.cn/large/006tNc79gy1g5o1la5tiej30j708caa5.jpg)

æˆ‘ä»¬éƒ½çŸ¥é“Reactæ˜¯åŸºäºè¿½è¸ªç»„ä»¶çŠ¶æ€æ›´æ–°å¹¶åŒæ­¥è‡³å±å¹•ä¸Šç”¨æ¥æ„å»ºç”¨æˆ·ç•Œé¢çš„å‰ç«¯åº“ã€‚åœ¨reactä¸­æˆ‘ä»¬çŸ¥é“è¿™æ˜¯åŸºäºä¸€ä¸ªåå«reconciliationï¼ˆè°ƒè§£ï¼‰çš„è¿‡ç¨‹ï¼Œæˆ‘ä»¬è°ƒç”¨`setState`æ–¹æ³•è€Œæ¡†æ¶å†…éƒ¨åˆ™æ¯”è¾ƒstateå’Œpropsçš„å˜åŒ–å»é‡ç»˜ç»„ä»¶æ›´æ–°UIç•Œé¢ã€‚

Reactçš„å®˜æ–¹æ–‡æ¡£å¯¹æ­¤æä¾›äº†ä¸€ä¸ªå¾ˆå¥½åœ°é«˜çº§æ¦‚è¿°ï¼šReactå…ƒç´ ã€ç”Ÿå‘½å‘¨æœŸå‡½æ•°ã€`render`å‡½æ•°çš„è§„åˆ™ä»¥åŠè¿ç”¨äºå­ç»„ä»¶çš„diffç®—æ³•ã€‚ä»renderæ–¹æ³•è¿”å›çš„ä¸å¯å˜Reactå…ƒç´ æ ‘é€šå¸¸ç§°ä¸ºâ€œè™šæ‹ŸDOMâ€ã€‚è¿™ä¸ªæœ¯è¯­å¾ˆæ—©å°±å¸®åŠ©äººä»¬è§£é‡Šäº†Reactï¼Œä½†æ˜¯åŒæ ·å¼•å…¥äº†ä»¤äººè¿·æƒ‘çš„äº‹æƒ…ï¼Œè€Œä¸”å¹¶æ²¡æœ‰åœ¨reactçš„å®˜æ–¹æ–‡æ¡£ä¸­æœ‰ä»»ä½•æåŠã€‚åœ¨æœ¬æ–‡ä¸­æˆ‘å°†åšç§°å…¶ä¸ºreactå…ƒç´ æ ‘ã€‚
é™¤äº†Reactå…ƒç´ æ ‘ï¼Œæ¡†æ¶å†…éƒ¨ä¹Ÿæ€»æ˜¯æœ‰å†…éƒ¨ç¤ºä¾‹æ ‘ï¼ˆæ¯”å¦‚ç»„ä»¶ã€DOMèŠ‚ç‚¹ç­‰ï¼‰ç”¨æ¥ä¿æŒå†…éƒ¨çŠ¶æ€ã€‚ä»ç‰ˆæœ¬16å¼€å§‹ï¼ŒReactæ¨å‡ºäº†è¯¥å†…éƒ¨å®ä¾‹æ ‘çš„æ–°å®ç°ä»¥åŠç®¡ç†ä»£å·ä¸ºFiberçš„ç®—æ³•ã€‚ä¸ºäº†äº†è§£Fiberæ¶æ„å¸¦æ¥çš„ä¼˜åŠ¿ï¼Œ[äº†è§£Reactåœ¨Fiberä¸­ä½¿ç”¨é“¾è¡¨çš„æ–¹å¼å’ŒåŸå› ](https://medium.com/dailyjs/the-how-and-why-on-reacts-usage-of-linked-list-in-fiber-67f1014d0eb7)ã€‚

> è¿™ç¯‡æ–‡ç« å¦‚æœæ²¡æœ‰[Dan Abramov](https://medium.com/@dan_abramov)çš„å¸®åŠ©çš„è¯ä¸€å®šä¼šèŠ±è´¹æ›´å¤šçš„æ—¶é—´ï¼Œè€Œä¸”æ²¡æœ‰å¦‚æ­¤å…¨é¢ã€‚

è¿™æ˜¯ä¸€ç³»åˆ—æ•™ä½ ç†è§£Reactå†…éƒ¨åŸç†çš„æ–‡ç« çš„ç¬¬ä¸€ç¯‡ã€‚åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘æƒ³æä¾›ä¸ç®—æ³•ç›¸å…³çš„é‡è¦æ¦‚å¿µå’Œæ•°æ®ç»“æ„çš„æ·±å…¥æ¦‚è¿°ï¼Œä¸€æ—¦æˆ‘ä»¬äº†è§£äº†è¶³å¤Ÿçš„èƒŒæ™¯çŸ¥è¯†ï¼Œæˆ‘ä»¬å°†ä¼šæ¢ç´¢ç”¨äºé€’å½’å’Œè§£æfiberæ ‘çš„ç®—æ³•å’Œä¸»è¦å‡½æ•°ã€‚æ­¤ç³»åˆ—çš„ä¸‹ä¸€ç¯‡æ–‡ç« å°†æ¼”ç¤ºReactå¦‚ä½•ä½¿ç”¨è¯¥ç®—æ³•æ‰§è¡Œåˆå§‹æ¸²æŸ“å’Œå¤„ç†stateä»¥åŠpropsæ›´æ–°ã€‚ä»é‚£é‡Œæˆ‘ä»¬å°†ç»§ç»­è®¨è®ºè°ƒåº¦ç¨‹åºçš„ç»†èŠ‚ï¼Œå­è°ƒè§£(reconciliation)è¿›ç¨‹ï¼Œä»¥åŠå»ºç«‹Effect listçš„æœºåˆ¶ã€‚

## ç»§ç»­ ##

æˆ‘å°†å¸¦ä½ ä¸€èµ·äº†è§£ä¸€äº›Reactçš„é«˜çº§çŸ¥è¯†ğŸ§™â€ã€‚æˆ‘é¼“åŠ±ä½ é˜…è¯»å®ƒä»¥äº†è§£Concurrent Reactå†…éƒ¨å·¥ä½œèƒŒåçš„é­”åŠ›ã€‚è€Œä¸”è¿™ä¸€ç³»åˆ—çš„æ–‡ç« ä¹Ÿèƒ½ä½œä¸ºæƒ³Reactå¼€æºé¡¹ç›®è´¡çŒ®çš„æŒ‡å—ã€‚æˆ‘éå¸¸ç›¸ä¿¡é€†å‘å·¥ç¨‹ï¼Œå› æ­¤æœ€æ–°ç‰ˆæœ¬16.6.0ä¸­çš„æºä»£ç ä¼šæœ‰å¾ˆå¤šé“¾æ¥ã€‚

è¿™é‡ŒåŒ…å«å¾ˆå¤šå†…å®¹ï¼Œæ‰€æœ‰å¦‚æœä½ ä¸èƒ½é©¬ä¸Šç†è§£çš„è¯ä¸è¦æ„Ÿåˆ°æœ‰å‹åŠ›ã€‚è¿™äº›å†…å®¹å€¼å¾—ä½ èŠ±æ—¶é—´å»äº†è§£ã€‚æ³¨æ„å¦‚æœåªæ˜¯ä¸ºäº†èƒ½ç†Ÿç»ƒä½¿ç”¨Reactï¼Œé‚£ä¹ˆä½ æ²¡å¿…è¦äº†è§£è¿™äº›å†…å®¹ã€‚è¿™ç¯‡æ–‡ç« æ˜¯ä¸ºäº†

## è®¾ç½®èƒŒæ™¯ ##

è¿™é‡Œæœ‰ä¸€ä¸ªç®€å•çš„ä¾‹å­æˆ‘å°†è´¯ç©¿è¿™ä¸€ç³»åˆ—æ–‡ç« ã€‚å±å¹•ä¸Šä¸ºä¸€ä¸ªé€’å¢çš„æŒ‰é’®ã€‚

![picture](http://ww4.sinaimg.cn/large/006tNc79gy1g5p8b2lejng305u01wq3m.gif)

å…·ä½“ä»£ç å¦‚ä¸‹

```javascript
class ClickCounter extends React.Component {
    constructor(props) {
        super(props);
        this.state = {count: 0};
        this.handleClick = this.handleClick.bind(this);
    }

    handleClick() {
        this.setState((state) => {
            return {count: state.count + 1};
        });
    }


    render() {
        return [
            <button key="1" onClick={this.handleClick}>Update counter</button>,
            <span key="2">{this.state.count}</span>
        ]
    }
}
```

ä½ å¯ä»¥åœ¨[æ­¤å¤„](https://stackblitz.com/edit/react-t4rdmh)è¿›è¡Œåœ¨çº¿æŸ¥çœ‹ï¼Œæ­£å¦‚ä½ æ‰€è§ï¼Œè¿™åªæ˜¯ä¸€ä¸ªç®€å•åŒ…å«`span`å’Œ`button`å…ƒç´ çš„ç»„ä»¶ã€‚å•å‡»è¯¥æŒ‰é’®åï¼Œç»„ä»¶çš„çŠ¶æ€å°†åœ¨å¤„ç†ç¨‹åºå†…æ›´æ–°ã€‚åè¿‡æ¥ï¼Œè¿™ä¼šå¯¼è‡´spanå…ƒç´ çš„æ–‡æœ¬æ›´æ–°ã€‚

è¿™é‡Œæœ‰å‡ ç§Reactä¼šåœ¨(reconciliation)è°ƒè§£è¿‡ç¨‹ä¸­ä¼šæ‰§è¡Œçš„æ“ä½œã€‚ä¾‹å¦‚ï¼Œä»¥ä¸‹æ˜¯Reactåœ¨æˆ‘ä»¬çš„ç®€å•åº”ç”¨ç¨‹åºä¸­çš„ç¬¬ä¸€æ¬¡æ¸²æŸ“å’ŒçŠ¶æ€æ›´æ–°ä¹‹åæ‰§è¡Œçš„é«˜çº§æ“ä½œï¼š

+ åœ¨`ClickCounter`ç»„ä»¶`state`ä¸­æ›´æ–°`count`å±æ€§
+ æ£€ç´¢å’Œæ¯”è¾ƒ`ClickCounter`ç»„ä»¶çš„`Children`å’Œ`Props`
+ æ›´æ–°`span`å…ƒç´ çš„`props`

åœ¨(reconciliation)è°ƒè§£çš„è¿‡ç¨‹ä¸­è¿˜æœ‰ä¸€äº›å…¶ä»–æ“ä½œè¢«æ‰§è¡Œä¾‹å¦‚è°ƒç”¨ç”Ÿå‘½å‘¨æœŸå‡½æ•°åŠæ›´æ–°`reef`ï¼Œæ‰€æœ‰è¿™äº›æ´»åŠ¨åœ¨`Fiber`æ¶æ„ä¸­ç»Ÿç§°ä¸ºâ€œ`work`â€ã€‚`work`çš„ç±»å‹é€šå¸¸éƒ½å–å†³äºReactç»„ä»¶çš„ç±»å‹ã€‚åˆ—å¦‚ï¼Œå¯¹äºClassç»„ä»¶ï¼ŒReactéœ€è¦å»åˆ›å»ºå®ä¾‹ï¼Œä½†å¯¹äºå‡½æ•°å¼ç»„ä»¶æ¥è¯´å´å¹¶ä¸ä¼šã€‚æ­£å¦‚ä½ æ‰€çŸ¥ï¼Œåœ¨Reacté‡Œé¢æœ‰å¤šç§ç»„ä»¶ç±»å‹ã€‚ä¾‹å¦‚ï¼šclasså’Œå‡½æ•°å¼ç»„ä»¶ï¼Œå®¿ä¸»ç»„ä»¶ã€`portals`ç­‰ã€‚Reactç»„ä»¶ç±»å‹æ˜¯ç”±`createElement`å‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°å†³å®šçš„ã€‚è¿™ä¸ªå‡½æ•°é€šå¸¸è¢«ç”¨äºåœ¨`render`æ–¹æ³•ä¸­åˆ›å»ºç»„ä»¶å…ƒç´ ã€‚

åœ¨æˆ‘ä»¬æ¢ç´¢`Fiber`æ¶æ„ä¹‹å‰ï¼Œå…ˆè®©æˆ‘ä»¬ç†Ÿæ‚‰ä¸€ä¸‹Reactå†…éƒ¨çš„æ•°æ®ç»“æ„ã€‚

## ä»React Elements åˆ°Fiber èŠ‚ç‚¹ ##

Reactä¸­çš„æ¯ä¸ªç»„ä»¶éƒ½æœ‰ä¸€ä¸ªUIè¡¨ç¤ºï¼Œæˆ‘ä»¬å¯ä»¥è°ƒç”¨ä¸€ä¸ªè§†å›¾æˆ–ä¸€ä¸ªä»renderæ–¹æ³•è¿”å›çš„æ¨¡æ¿ã€‚ä¸‹é¢æ˜¯æˆ‘ä»¬`ClickCounter`ç»„ä»¶çš„æ¨¡æ¿ä»£ç ã€‚

```javascript
<button key="1" onClick={this.onClick}>Update counter</button>
<span key="2">{this.state.count}</span>
```

## React å…ƒç´  ##

å½“æ¨¡æ¿é€šè¿‡JSXçš„è§£é‡Šå™¨åï¼Œä½ å°†ä¼šå¾—åˆ°ä¸€ç³»åˆ—çš„Reactå…ƒç´ ã€‚è¿™æ‰æ˜¯reactç»„ä»¶çš„`render`æ–¹æ³•çœŸæ­£è¿”å›çš„æ ¼å¼ï¼Œè€Œä¸æ˜¯ä½ çœ‹è§çš„`HTML`æ¨¡æ¿ã€‚å¦‚æœä¸ä½¿ç”¨JSXçš„è¯ï¼Œé‚£ä¹ˆæˆ‘ä»¬çš„ç»„ä»¶å¯ä»¥å†™æˆæ‰æ ·ã€‚

```javascript
class ClickCounter {
    ...
    render() {
        return [
            React.createElement(
                'button',
                {
                    key: '1',
                    onClick: this.onClick
                },
                'Update counter'
            ),
            React.createElement(
                'span',
                {
                    key: '2'
                },
                this.state.count
            )
        ]
    }
}
```

`render`æ–¹æ³•ä¸­çš„`React.createElement`è°ƒç”¨ç»“æœå°†ä¼šè¿”å›ä¸‹é¢çš„æ•°æ®ç»“æ„ï¼š

```javascript
[
    {
        $$typeof: Symbol(react.element),
        type: 'button',
        key: "1",
        props: {
            children: 'Update counter',
            onClick: () => { ... }
        }
    },
    {
        $$typeof: Symbol(react.element),
        type: 'span',
        key: "2",
        props: {
            children: 0
        }
    }
]
```

æˆ‘ä»¬å¯ä»¥çœ‹åˆ°Reactä¸ºè¿™äº›å¯¹è±¡æ·»åŠ äº†`$$typeof`å±æ€§å”¯ä¸€çš„å°†ä»–ä»¬æ ‡è¯†ä¸ºReactå…ƒç´ ã€‚ç”¨`type`ã€`key`å’Œ`props`æè¿°æ­¤å¯¹è±¡ã€‚è€Œä»–ä»¬çš„å€¼å°±æ˜¯ä½ é€šè¿‡`React.createElement`ä¼ è¿‡æ¥çš„å€¼ã€‚è¯·æ³¨æ„Reactå¦‚ä½•å°†æ–‡æœ¬å†…å®¹è¡¨ç¤ºä¸º`span`å’ŒæŒ‰é’®èŠ‚ç‚¹çš„å­é¡¹ã€‚å’Œ`click`çš„ç›‘å¬å‡½æ•°æ˜¯å¦‚ä½•ä½œä¸º`button`å…ƒç´ çš„`props`ã€‚Reactå…¶ä»–æ–¹é¢æ¯”å¦‚`ref`å­—æ®µå°±è¶…å‡ºäº†æœ¬æ–‡çš„è®¨è®ºèŒƒå›´ã€‚

`ClickCounter`çš„Reactå…ƒç´ å¹¶æ²¡æœ‰ä»»ä½•çš„`props`å’Œ`key`:

```javascript
{
    $$typeof: Symbol(react.element),
    key: null,
    props: {},
    ref: null,
    type: ClickCounter
}
```

## FiberèŠ‚ç‚¹ ##

åœ¨è°ƒè§£(reconciliation)æœŸé—´Reactç»„ä»¶çš„`render`æ–¹æ³•è¿”å›çš„æ•°æ®ä¼šè¢«åˆå¹¶è¿›å…¥fiberèŠ‚ç‚¹æ ‘ä¸­ã€‚ä¸Reactç»„ä»¶ä¸ä¸€æ ·ï¼Œfiberä¸ä¼šå†æ¯ä¸ªæ¸²æŸ“å‘¨æœŸå†…é‡æ–°åˆ›å»ºã€‚ä»–ä»¬æ˜¯åŒ…å«ç»„ä»¶çŠ¶æ€å’ŒDOMèŠ‚ç‚¹çš„å¯å˜æ•°æ®ç»“æ„ã€‚

[åŸæ–‡é“¾æ¥](https://blog.ag-grid.com/inside-fiber-an-in-depth-overview-of-the-new-reconciliation-algorithm-in-react/)
